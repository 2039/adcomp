<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>The comprehensive TMB documentation</title>
  <meta name="description" content="Comprehensive documentation of TMB - theory and examples.">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="The comprehensive TMB documentation" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://kaskr.github.io/adcomp/" />
  <meta property="og:image" content="https://kaskr.github.io/adcomp/images/cover.png" />
  <meta property="og:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="github-repo" content="kaskr/adcomp" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="The comprehensive TMB documentation" />
  
  <meta name="twitter:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="twitter:image" content="https://kaskr.github.io/adcomp/images/cover.png" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="Sparsity.html">
<link rel="next" href="Appendix.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="Tutorial.html"><a href="Tutorial.html"><i class="fa fa-check"></i><b>1</b> Tutorial</a><ul>
<li class="chapter" data-level="1.1" data-path="Tutorial.html"><a href="Tutorial.html#obtaining-data-and-parameter-values-from-r"><i class="fa fa-check"></i><b>1.1</b> Obtaining data and parameter values from R</a></li>
<li class="chapter" data-level="1.2" data-path="Tutorial.html"><a href="Tutorial.html#an-extended-c-language"><i class="fa fa-check"></i><b>1.2</b> An extended C++ language</a></li>
<li class="chapter" data-level="1.3" data-path="Tutorial.html"><a href="Tutorial.html#statistical-modelling"><i class="fa fa-check"></i><b>1.3</b> Statistical modelling</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="Structure-TMB.html"><a href="Structure-TMB.html"><i class="fa fa-check"></i><b>2</b> The structure of TMB</a></li>
<li class="chapter" data-level="3" data-path="matrix-arrays.html"><a href="matrix-arrays.html"><i class="fa fa-check"></i><b>3</b> Matrices and arrays</a><ul>
<li class="chapter" data-level="3.1" data-path="matrix-arrays.html"><a href="matrix-arrays.html#relationship-to-r"><i class="fa fa-check"></i><b>3.1</b> Relationship to R</a></li>
<li class="chapter" data-level="3.2" data-path="matrix-arrays.html"><a href="matrix-arrays.html#relationship-to-eigen"><i class="fa fa-check"></i><b>3.2</b> Relationship to Eigen</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="R-style-distribution.html"><a href="R-style-distribution.html"><i class="fa fa-check"></i><b>4</b> R style probability distributions</a></li>
<li class="chapter" data-level="5" data-path="Densities.html"><a href="Densities.html"><i class="fa fa-check"></i><b>5</b> Multivariate distributions</a><ul>
<li class="chapter" data-level="5.1" data-path="Densities.html"><a href="Densities.html#multivariate-normal-distributions"><i class="fa fa-check"></i><b>5.1</b> Multivariate normal distributions</a></li>
<li class="chapter" data-level="5.2" data-path="Densities.html"><a href="Densities.html#autoregressive-processes"><i class="fa fa-check"></i><b>5.2</b> Autoregressive processes</a></li>
<li class="chapter" data-level="5.3" data-path="Densities.html"><a href="Densities.html#gaussian-markov-random-fields-gmrf"><i class="fa fa-check"></i><b>5.3</b> Gaussian Markov random fields (GMRF)</a></li>
<li class="chapter" data-level="5.4" data-path="Densities.html"><a href="Densities.html#separable-construction-of-covariance-precision-matrices"><i class="fa fa-check"></i><b>5.4</b> Separable construction of covariance (precision) matrices</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="Examples.html"><a href="Examples.html"><i class="fa fa-check"></i><b>6</b> Example collection</a><ul>
<li class="chapter" data-level="6.1" data-path="Examples.html"><a href="Examples.html#example-overview"><i class="fa fa-check"></i><b>6.1</b> Example overview</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Errors.html"><a href="Errors.html"><i class="fa fa-check"></i><b>7</b> Compilation and run time errors</a><ul>
<li class="chapter" data-level="7.1" data-path="Errors.html"><a href="Errors.html#compilation-errors"><i class="fa fa-check"></i><b>7.1</b> Compilation errors</a></li>
<li class="chapter" data-level="7.2" data-path="Errors.html"><a href="Errors.html#run-time-errors"><i class="fa fa-check"></i><b>7.2</b> Run time errors</a><ul>
<li class="chapter" data-level="7.2.1" data-path="Errors.html"><a href="Errors.html#out-of-bounds-error"><i class="fa fa-check"></i><b>7.2.1</b> Out-of-bounds error</a></li>
<li class="chapter" data-level="7.2.2" data-path="Errors.html"><a href="Errors.html#floating-point-exception"><i class="fa fa-check"></i><b>7.2.2</b> Floating point exception</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="Toolbox.html"><a href="Toolbox.html"><i class="fa fa-check"></i><b>8</b> Toolbox</a><ul>
<li class="chapter" data-level="8.0.1" data-path="Toolbox.html"><a href="Toolbox.html#non-normal-latent-variables-random-effects"><i class="fa fa-check"></i><b>8.0.1</b> Non-normal latent variables (random effects)</a></li>
<li class="chapter" data-level="8.0.2" data-path="Toolbox.html"><a href="Toolbox.html#discrete-latent-variables"><i class="fa fa-check"></i><b>8.0.2</b> Discrete latent variables</a></li>
<li class="chapter" data-level="8.0.3" data-path="Toolbox.html"><a href="Toolbox.html#mixture-models"><i class="fa fa-check"></i><b>8.0.3</b> Mixture models</a></li>
<li class="chapter" data-level="8.0.4" data-path="Toolbox.html"><a href="Toolbox.html#time-series"><i class="fa fa-check"></i><b>8.0.4</b> Time series</a></li>
<li class="chapter" data-level="8.0.5" data-path="Toolbox.html"><a href="Toolbox.html#spatial-models"><i class="fa fa-check"></i><b>8.0.5</b> Spatial models</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="CppTutorial.html"><a href="CppTutorial.html"><i class="fa fa-check"></i><b>9</b> C++ tutorial</a><ul>
<li class="chapter" data-level="9.0.1" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-r-but-not-c"><i class="fa fa-check"></i><b>9.0.1</b> I know R but not C++</a></li>
<li class="chapter" data-level="9.0.2" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-c"><i class="fa fa-check"></i><b>9.0.2</b> I know C++</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ModelObject.html"><a href="ModelObject.html"><i class="fa fa-check"></i><b>10</b> Model object</a></li>
<li class="chapter" data-level="11" data-path="Sparsity.html"><a href="Sparsity.html"><i class="fa fa-check"></i><b>11</b> Sparsity</a><ul>
<li class="chapter" data-level="11.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence-graphs-and-dags"><i class="fa fa-check"></i><b>11.1</b> Conditional independence graphs and DAGs</a><ul>
<li class="chapter" data-level="11.1.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence"><i class="fa fa-check"></i><b>11.1.1</b> Conditional independence</a></li>
<li class="chapter" data-level="11.1.2" data-path="Sparsity.html"><a href="Sparsity.html#node-removal-properties"><i class="fa fa-check"></i><b>11.1.2</b> Node removal properties</a></li>
<li class="chapter" data-level="11.1.3" data-path="Sparsity.html"><a href="Sparsity.html#directed-acyclic-graph"><i class="fa fa-check"></i><b>11.1.3</b> Directed acyclic graph</a></li>
<li class="chapter" data-level="11.1.4" data-path="Sparsity.html"><a href="Sparsity.html#the-effect-of-adding-data"><i class="fa fa-check"></i><b>11.1.4</b> The effect of adding data</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="Sparsity.html"><a href="Sparsity.html#the-theta-logistic-example"><i class="fa fa-check"></i><b>11.2</b> The theta logistic example</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="Simulation.html"><a href="Simulation.html"><i class="fa fa-check"></i><b>12</b> Simulation</a><ul>
<li class="chapter" data-level="12.1" data-path="Simulation.html"><a href="Simulation.html#overview-of-simulation-methods-in-tmb"><i class="fa fa-check"></i><b>12.1</b> Overview of simulation methods in TMB</a><ul>
<li class="chapter" data-level="12.1.1" data-path="Simulation.html"><a href="Simulation.html#standard-generators"><i class="fa fa-check"></i><b>12.1.1</b> Standard generators</a></li>
<li class="chapter" data-level="12.1.2" data-path="Simulation.html"><a href="Simulation.html#generators-for-density-objects"><i class="fa fa-check"></i><b>12.1.2</b> Generators for density objects</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="Simulation.html"><a href="Simulation.html#simulation-blocks"><i class="fa fa-check"></i><b>12.2</b> Simulation blocks</a><ul>
<li class="chapter" data-level="12.2.1" data-path="Simulation.html"><a href="Simulation.html#a-linear-regression-example"><i class="fa fa-check"></i><b>12.2.1</b> A linear regression example</a></li>
<li class="chapter" data-level="12.2.2" data-path="Simulation.html"><a href="Simulation.html#a-simulation-study"><i class="fa fa-check"></i><b>12.2.2</b> A simulation study</a></li>
<li class="chapter" data-level="12.2.3" data-path="Simulation.html"><a href="Simulation.html#advanced-examples"><i class="fa fa-check"></i><b>12.2.3</b> Advanced examples</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="Appendix.html"><a href="Appendix.html"><i class="fa fa-check"></i><b>13</b> Appendix</a><ul>
<li class="chapter" data-level="13.1" data-path="Appendix.html"><a href="Appendix.html#notation"><i class="fa fa-check"></i><b>13.1</b> Notation</a></li>
<li class="chapter" data-level="13.2" data-path="Appendix.html"><a href="Appendix.html#profiling-the-inner-problem"><i class="fa fa-check"></i><b>13.2</b> Profiling the inner problem</a></li>
<li class="chapter" data-level="13.3" data-path="Appendix.html"><a href="Appendix.html#example"><i class="fa fa-check"></i><b>13.3</b> Example</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The comprehensive TMB documentation</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Simulation" class="section level1">
<h1><span class="header-section-number">12</span> Simulation</h1>
<p>When building models in TMB it is generally recommended to test the implementation on simulated data. Obviously, data can be simulated from R and passed to the C++ template. In practice this amounts to implementing the model twice and is thus a strong way to validate the implementation of the model. However, with increased model complexity it becomes inconvenient to maintain two separate implementations. Therefore, TMB allows the the user to write the simulation code as an integrated part of the C++ model template.</p>
<div id="overview-of-simulation-methods-in-tmb" class="section level2">
<h2><span class="header-section-number">12.1</span> Overview of simulation methods in TMB</h2>
<div id="standard-generators" class="section level3">
<h3><span class="header-section-number">12.1.1</span> Standard generators</h3>
<p>The TMB simulation routines use the same naming convention as the R simulators. For instance <code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>()</code> is used to simulate from a normal distribution. However, the argument convention is slightly different:</p>
<ol style="list-style-type: decimal">
<li><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(n, mu, sd)</code> draws <code>n</code> simulations from a normal distribution. Unlike R this works for <strong>scalar parameters only</strong>.</li>
<li><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(mu, sd)</code> is a TMB specific variant that works for <strong>mixed scalar and vector input</strong>. Output length follows the length of the longest input (no re-cycling) hence is consistent with <code>dnorm(mu, sd)</code>.</li>
</ol>
<p>Currently the following simulators are implemented:</p>
<blockquote>
<p><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e">rpois</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a6bba21a2132e3504e183cdcd3e3e30cd">runif</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a29a4e821ec4b62567f8b40ab6ae78187">rbinom</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a74162523131288cf49a0d5d2e7c55253">rgamma</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#ae83ce74738a3b97e3432225a9036c99a">rexp</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#ae5f4590feabf617af4f525518b5802b8">rbeta</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#afc356ef7a9514c2629dd14de76e7e265">rf</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a266f56242a3cae0326439727b9f20b47">rlogis</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#af610012a7bedea646cc43a7dff276639">rt</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a2f3b0e14bca65b9153d89e797bdc37dd">rweibull</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a6b70740b28883180856ab723d264c12a">rcompois</a>()</code>, <code><a class="code" href="../lgamma_8hpp.html#a37ea00b66863cc66e267cfc5ced6c9ee">rnbinom</a>()</code>, <code><a class="code" href="../lgamma_8hpp.html#abbdff2745abaa2784b9350f1db929c3e">rnbinom2</a>()</code></p>
</blockquote>
</div>
<div id="generators-for-density-objects" class="section level3">
<h3><span class="header-section-number">12.1.2</span> Generators for density objects</h3>
<p>Objects from the density namespace have their own <code><a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>()</code> method. Taking the multivariate normal distribution as example we have the following ways to draw a simulation:</p>
<ol style="list-style-type: decimal">
<li><code><a class="code" href="../density_8hpp.html#a0ab00cdcb2757d23910a6d54523eec07">MVNORM</a>(Sigma).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>()</code> returns a vector with a simulation from the multivariate normal distribution. The void argument version is only available when there is no ambiguity in the dimension of the output. In the <code>MVNORM</code> case the dimension of the output is known from the dimension of <code>Sigma</code>. In other cases e.g. <code>AR1(phi)</code> the dimension of the output is not known hence the void argument version is not available.</li>
<li><code><a class="code" href="../density_8hpp.html#a0ab00cdcb2757d23910a6d54523eec07">MVNORM</a>(Sigma).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>(x)</code> pass <code>x</code> by reference and writes the simulation directly to <code>x</code> without returning anything. This version is available for <em>all</em> the classes because the dimension of the simulation can always be deduced from <code>x</code>.</li>
</ol>
</div>
</div>
<div id="simulation-blocks" class="section level2">
<h2><span class="header-section-number">12.2</span> Simulation blocks</h2>
<p>Simulation functions can be called from anywhere in the C++ program. However, usually one should put the simulation code inside specialized <em>simulation blocks</em> that allows the code to only be executed when requested from R.</p>
<div id="a-linear-regression-example" class="section level3">
<h3><span class="header-section-number">12.2.1</span> A linear regression example</h3>
<p>A complete example extending the example <a href="../linreg_8cpp-example.html">linreg.cpp</a> with simulation code is:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">
<span class="ot">#include &lt;<a class="code" href="../TMB_8hpp.html">TMB.hpp</a>&gt;</span>
<span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;
Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()
{
  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(y);
  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(x);
  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(a);
  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(b);
  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(sd);
  <a class="code" href="../structvector.html">vector</a>&lt;Type&gt; mu = a + b * x;
  Type nll = -<a class="code" href="../convenience_8hpp.html#a1fe3cb777e8fd8080385579ab87600e3">sum</a>(dnorm(y, mu, sd, <span class="kw">true</span>));
  <a class="code" href="../group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {
    y = <a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(mu, sd);  <span class="co">// Simulate response</span>
    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(y);          <span class="co">// Report the simulation</span>
  }
  <span class="kw">return</span> nll;
}</code></pre></div>
<blockquote>
<p>The <code>SIMULATE</code> block marks the simulation and is not executed by default.</p>
</blockquote>
<p>We compile the C++-file and the model object is constructed as usual:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">obj &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(data, parameters, <span class="dt">DLL=</span><span class="st">&quot;linreg&quot;</span>)</code></pre></div>
<p>Now a simulation can be generated with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">simulate</span>()</code></pre></div>
<pre><code>## $y
##  [1]  1.2240818  0.3598138  0.4007715  0.1106827 -0.5558411  1.7869131
##  [7]  0.4978505 -1.9666172  0.7013559 -0.4727914</code></pre>
<p>This only includes the simulated response - not the rest of the data. A complete dataset can be generated by:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">simulate</span>(<span class="dt">complete=</span><span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## $y
##  [1] -1.0678237 -0.2179749 -1.0260044 -0.7288912 -0.6250393 -1.6866933
##  [7]  0.8377870  0.1533731 -1.1381369  1.2538149
## 
## $x
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## attr(,&quot;check.passed&quot;)
## [1] TRUE</code></pre>
<p>Here we did not explicitely state the parameter values to use with the simulation. The <code>simulate</code> method takes an additional argument <code>par</code> that can be used for this.</p>
<blockquote>
<p>The default parameter values used for the simulation is <code>obj$env$last.par</code>.</p>
</blockquote>
</div>
<div id="a-simulation-study" class="section level3">
<h3><span class="header-section-number">12.2.2</span> A simulation study</h3>
<p>Simulating datasets from known parameters and re-estimationg those parameters can be done generically by:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">50</span>, {
  simdata &lt;-<span class="st"> </span>obj$<span class="kw">simulate</span>(<span class="dt">par=</span>obj$par, <span class="dt">complete=</span><span class="ot">TRUE</span>)
  obj2 &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(simdata, parameters, <span class="dt">DLL=</span><span class="st">&quot;linreg&quot;</span>, <span class="dt">silent=</span><span class="ot">TRUE</span>)
  <span class="kw">nlminb</span>(obj2$par, obj2$fn, obj2$gr)$par
})</code></pre></div>
<p>We reshape and plot the result:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lattice)
<a class="code" href="../group__R__style__distribution.html#ga6297091307163f5bb21e1a526fc8044a">df</a> &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">estimate=</span><span class="kw">as.vector</span>(sim), <span class="dt">parameter=</span><span class="kw">names</span>(obj$par)[<span class="kw">row</span>(sim)])
<span class="kw">densityplot</span>( ~<span class="st"> </span>estimate |<span class="st"> </span>parameter, <span class="dt">data=</span><a class="code" href="../group__R__style__distribution.html#ga6297091307163f5bb21e1a526fc8044a">df</a>, <span class="dt">layout=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-27-1.svg" width="336" style="display: block; margin: auto;" /></p>
<p>Compare with the true parameter values of the simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">obj$par</code></pre></div>
<pre><code>##  a  b sd 
##  0  0  1</code></pre>
</div>
<div id="advanced-examples" class="section level3">
<h3><span class="header-section-number">12.2.3</span> Advanced examples</h3>
<p>The examples <a href="../sam_8cpp-example.html">sam.cpp</a> and <a href="../ar1_4D_8cpp-example.html">ar1_4D.cpp</a> includes more advanced simulation code. The latter demonstrates how to simulate from the density objects:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// Separable covariance on 4D lattice with AR1 structure in each direction.</span>
<span class="ot">#include &lt;<a class="code" href="../TMB_8hpp.html">TMB.hpp</a>&gt;</span>

<span class="co">/* Parameter transform */</span>
<span class="kw">template</span> &lt;<span class="kw">class</span> Type&gt;
Type f(Type x){<span class="kw">return</span> Type(<span class="dv">2</span>)/(Type(<span class="dv">1</span>) + exp(-Type(<span class="dv">2</span>) * x)) - Type(<span class="dv">1</span>);}

<span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;
Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()
{
  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(N)
  <a class="code" href="../group__macros.html#ga6ac3eddb1dd503ceaf4c6ac91546b23e">PARAMETER_ARRAY</a>(eta);
  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(transf_phi); <span class="co">/* fastest running dim */</span>
  Type phi=f(transf_phi);
  <a class="code" href="../group__macros.html#ga43a13c435127491364e4a167478f4992">ADREPORT</a>(phi);

  <span class="kw">using</span> <span class="kw">namespace</span> <a class="code" href="../namespacedensity.html">density</a>;
  Type res=<span class="dv">0</span>;

  res+=AR1(phi,AR1(phi,AR1(phi,AR1(phi))))(eta);

  <span class="co">// logdpois = N log lam - lam</span>
  <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;N.size();i++)res-=N[i]*eta[i]-exp(eta[i]);

  <a class="code" href="../group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {
    AR1(phi,AR1(phi,AR1(phi,AR1(phi)))).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>(eta);
    <a class="code" href="../structvector.html">vector</a>&lt;Type&gt; lam = exp(eta);
    N = <a class="code" href="../distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e">rpois</a>(lam);
    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(eta);
    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(N);
  }

  <span class="kw">return</span> res;

}</code></pre></div>
<p>In this example the 4D-array <code>eta</code> is passed to the simulator by reference. Thereby the simulator knows the dimension of <code>eta</code> and can fill <code>eta</code> with a simulation.</p>




</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Sparsity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
