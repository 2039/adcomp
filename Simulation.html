<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>TMB Documentation: Simulation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TMB Documentation
   &#160;<span id="projectnumber">v1.7.5</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Simulation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>When building models in TMB it is generally recommended to test the implementation on simulated data. Obviously, data can be simulated from R and passed to the C++ template. In practice this amounts to implementing the model twice and is thus a strong way to validate the implementation of the model. However, with increased model complexity it becomes inconvenient to maintain two separate implementations. Therefore, TMB allows the the user to write the simulation code as an integrated part of the C++ model template.</p>
<h2>Overview of simulation methods in TMB</h2>
<h3>Standard generators</h3>
<p>The TMB simulation routines use the same naming convention as the R simulators. For instance <code><a class="el" href="distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c" title="Simulate from a normal distribution. ">rnorm()</a></code> is used to simulate from a normal distribution. However, the argument convention is slightly different:</p>
<ol type="1">
<li><code>rnorm(n, mu, sd)</code> draws <code>n</code> simulations from a normal distribution. Unlike R this works for <b>scalar parameters only</b>.</li>
<li><code>rnorm(mu, sd)</code> is a TMB specific variant that works for <b>mixed scalar and vector input</b>. Output length follows the length of the longest input (no re-cycling) hence is consistent with <code>dnorm(mu, sd)</code>.</li>
</ol>
<p>Currently the following simulators are implemented:</p>
<blockquote class="doxtable">
<p><code><a class="el" href="distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c" title="Simulate from a normal distribution. ">rnorm()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e" title="Simulate from a Poisson distribution. ">rpois()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a6bba21a2132e3504e183cdcd3e3e30cd" title="Simulate from a uniform distribution. ">runif()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a29a4e821ec4b62567f8b40ab6ae78187" title="Simulate from a binomial distribution. ">rbinom()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a74162523131288cf49a0d5d2e7c55253" title="Simulate from a gamma distribution. ">rgamma()</a></code>, <code>rexp;()</code>, <code>rbeta;()</code>, <code>rf;()</code>, <code>rlogis;()</code>, <code>rt;()</code>, <code>rweibull;()</code>, <code><a class="el" href="lgamma_8hpp.html#a37ea00b66863cc66e267cfc5ced6c9ee" title="Simulate from a negative binomial distribution. ">rnbinom()</a></code>, <code><a class="el" href="lgamma_8hpp.html#abbdff2745abaa2784b9350f1db929c3e" title="Simulate from a negative binomial distribution. ">rnbinom2()</a></code></p>
<p></p>
</blockquote>
<h3>Generators for density objects</h3>
<p>Objects from the density namespace have their own <code>simulate()</code> method. Taking the multivariate normal distribution as example we have the following ways to draw a simulation:</p>
<ol type="1">
<li><code>MVNORM(Sigma).simulate()</code> returns a vector with a simulation from the multivariate normal distribution. The void argument version is only available when there is no ambiguity in the dimension of the output. In the <code>MVNORM</code> case the dimension of the output is known from the dimension of <code>Sigma</code>. In other cases e.g. <code>AR1(phi)</code> the dimension of the output is not known hence the void argument version is not available.</li>
<li><code>MVNORM(Sigma).simulate(x)</code> pass <code>x</code> by reference and writes the simulation directly to <code>x</code> without returning anything. This version is available for <em>all</em> the classes because the dimension of the simulation can always be deduced from <code>x</code>.</li>
</ol>
<h2>Simulation blocks</h2>
<p>Simulation functions can be called from anywhere in the C++ program. However, usually one should put the simulation code inside specialized <em>simulation blocks</em> that allows the code to only be executed when requested from R.</p>
<h3>A linear regression example</h3>
<p>A complete example extending the example <a class="el" href="linreg_8cpp-example.html">linreg.cpp</a> with simulation code is:</p>
<p>```{cpp}</p>
<p>#include &lt;<a class="el" href="TMB_8hpp.html" title="Includes and sets all stuff needed to compile the user defined objective function. ">TMB.hpp</a>&gt; template&lt;class Type&gt; Type objective_function&lt;Type&gt;::operator() () { <a class="el" href="group__macros.html#gad334262a7679f343bdc919ae35810161" title="Get data vector from R and declare it as vector&lt;Type&gt; ">DATA_VECTOR(y)</a>; <a class="el" href="group__macros.html#gad334262a7679f343bdc919ae35810161" title="Get data vector from R and declare it as vector&lt;Type&gt; ">DATA_VECTOR(x)</a>; <a class="el" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0" title="Get parameter scalar from R and declare it as Type. ">PARAMETER(a)</a>; <a class="el" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0" title="Get parameter scalar from R and declare it as Type. ">PARAMETER(b)</a>; <a class="el" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0" title="Get parameter scalar from R and declare it as Type. ">PARAMETER(sd)</a>; vector&lt;Type&gt; mu = a + b * x; Type nll = -sum(dnorm(y, mu, sd, true)); SIMULATE { y = rnorm(mu, sd); // Simulate response <a class="el" href="group__macros.html#gac2d7888f4e0385930448f992de53079b" title="Report scalar, vector or array back to R without derivative information. ">REPORT(y)</a>; // Report the simulation } return nll; }</p>
<p>```</p>
<blockquote class="doxtable">
<p>The <code>SIMULATE</code> block marks the simulation and is not executed by default.</p>
<p></p>
</blockquote>
<p>We compile the C++-file and the model object is constructed as usual:</p>
<p>```r obj &lt;- MakeADFun(data, parameters, DLL="linreg") ```</p>
<p>Now a simulation can be generated with</p>
<p>```r obj$simulate() ```</p>
<p>``` </p>
<h2>$y</h2>
<h2>[1] 1.2240818 0.3598138 0.4007715 0.1106827 -0.5558411 1.7869131</h2>
<h2>[7] 0.4978505 -1.9666172 0.7013559 -0.4727914</h2>
<p>```</p>
<p>This only includes the simulated response - not the rest of the data. A complete dataset can be generated by:</p>
<p>```r obj$simulate(complete=TRUE) ```</p>
<p>``` </p>
<h2>$y</h2>
<h2>[1] -1.0678237 -0.2179749 -1.0260044 -0.7288912 -0.6250393 -1.6866933</h2>
<h2>[7] 0.8377870 0.1533731 -1.1381369 1.2538149</h2>
<h2></h2>
<h2>$x</h2>
<h2>[1] 1 2 3 4 5 6 7 8 9 10</h2>
<h2></h2>
<h2>attr(,"check.passed")</h2>
<h2>[1] TRUE</h2>
<p>```</p>
<h3>Advanced examples</h3>
<p>The examples <a class="el" href="sam_8cpp-example.html">sam.cpp</a> and <a class="el" href="ar1_4D_8cpp-example.html">ar1_4D.cpp</a> includes more advanced simulation code. The latter demonstrates how to simulate from the density objects:</p>
<p>```{cpp} // Separable covariance on 4D lattice with AR1 structure in each direction. #include &lt;<a class="el" href="TMB_8hpp.html" title="Includes and sets all stuff needed to compile the user defined objective function. ">TMB.hpp</a>&gt;</p>
<p>/* Parameter transform template &lt;class type&gt;=""&gt; Type f(Type x){return Type(2)/(Type(1) + exp(-Type(2) * x)) - Type(1);}</p>
<p>template&lt;class Type&gt; Type objective_function&lt;Type&gt;::operator() () { <a class="el" href="group__macros.html#gad334262a7679f343bdc919ae35810161" title="Get data vector from R and declare it as vector&lt;Type&gt; ">DATA_VECTOR(N)</a> <a class="el" href="group__macros.html#ga6ac3eddb1dd503ceaf4c6ac91546b23e" title="Get parameter array from R and declare it as array&lt;Type&gt; ">PARAMETER_ARRAY(eta)</a>; <a class="el" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0" title="Get parameter scalar from R and declare it as Type. ">PARAMETER(transf_phi)</a>; /* fastest running dim Type phi=f(transf_phi); <a class="el" href="group__macros.html#ga43a13c435127491364e4a167478f4992" title="Report scalar, vector or array back to R with derivative information. ">ADREPORT(phi)</a>;</p>
<p>using namespace density; Type res=0;</p>
<p>res+=AR1(phi,AR1(phi,AR1(phi,AR1(phi))))(eta);</p>
<p>// logdpois = N log lam - lam for(int i=0;i&lt;N.size();i++)res-=N[i]*eta[i]-exp(eta[i]);</p>
<p>SIMULATE { AR1(phi,AR1(phi,AR1(phi,AR1(phi)))).simulate(eta); vector&lt;Type&gt; lam = exp(eta); N = rpois(lam); <a class="el" href="group__macros.html#gac2d7888f4e0385930448f992de53079b" title="Report scalar, vector or array back to R without derivative information. ">REPORT(eta)</a>; <a class="el" href="group__macros.html#gac2d7888f4e0385930448f992de53079b" title="Report scalar, vector or array back to R without derivative information. ">REPORT(N)</a>; }</p>
<p>return res;</p>
<p>} ```</p>
<p>In this example the 4D-array <code>eta</code> is passed to the simulator by reference. Thereby the simulator knows the dimension of <code>eta</code> and can fill <code>eta</code> with a simulation.</p>
<p>Adding simulation code to the model template </p>
</div></div><!-- contents -->
License: <a href="https://gnu.org/licenses/old-licenses/gpl-2.0.txt">GPL v2</a>
